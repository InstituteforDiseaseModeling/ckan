version: "3"

networks:
  test-net:

services:
  ckan-test:
    image: idm_ckan-test
    container_name: ckan-test
    build:
      context: ""
    links:
      - db-test
      - solr-test
      - redis-test
    depends_on:
      - db-test
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - DS_RO_PASS=${POSTGRES_PASSWORD}
      - CKAN_TEST_RUN=${CKAN_TEST_RUN}
      - CKAN_TEST
      - EXT_TEST
      - IDM_TEST_ONLY=${IDM_TEST_ONLY}
    networks:
      test-net:
        aliases:
        - ckan
    ports:
      - "5001:5000"
    volumes:
      - ${CKAN_TEST_RESULTS_OUT}:/home/ckan/test_results

  datapusher-test:
    container_name: datapusher-test
    image: clementmouchet/datapusher
    networks:
      test-net:
        aliases:
        - datapusher
    ports:
      - "8801:8800"
    logging:
      driver: "none"   

  db-test:
    image: idm_db-test
    container_name: db-test
    build:
      context: ../../../..
      dockerfile: ckanext/idm/deploy/postgresql/Dockerfile
      args:
      - DS_RO_PASS=${DATASTORE_READONLY_PASSWORD}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    environment:
      - DS_RO_PASS=${DATASTORE_READONLY_PASSWORD}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      test-net:
        aliases:
        - db
    ports:
      - "5433:5432"
    logging:
      driver: "none"     

  solr-test:
    image: idm_solr-test
    container_name: solr-test
    build:
      context: ../../../..
      dockerfile: ckanext/idm/deploy/solr/Dockerfile
    networks:
      test-net:
        aliases:
        - solr
    ports:
      - "8984:8983"
    logging:
      driver: "none"    

  redis-test:
    container_name: redis-test
    image: redis:latest
    networks:
      test-net:
        aliases:
        - redis
    ports:
      - "6380:6379"
    logging:
      driver: "none"    
